import socket
import threading
import selectors
import sys

BLACKLISTED_PORTS = {
    # Microsoft RPC/SMB/NetBIOS
    135, 137, 138, 139, 445,
    
    # LDAP
    389, 636, 3268, 3269,
    
    # Database services
    1433,   # MS SQL Server
    1521,   # Oracle DB
    3306,   # MySQL
    5432,   # PostgreSQL
    6379,   # Redis
    27017,  # MongoDB

    # Remote desktop and terminal services
    3389,   # RDP
    22,     # SSH (optional, in case you want to skip it)
    23,     # Telnet

    # Email servers (optional)
    25,     # SMTP
    110,    # POP3
    143,    # IMAP

    # Web servers (optional)
    80,     # HTTP
    443,    # HTTPS
}

open_ports = []
lock = threading.Lock()

def scan_port(host, port):
    if port in BLACKLISTED_PORTS:
        return
    try:
        with socket.create_connection((host, port), timeout=1) as sock:
            with lock:
                open_ports.append(port)
                print(f"[+] Open port: {port}")
    except:
        pass

def scan_all_ports(host):
    threads = []
    print("[*] Scanning ports...")
    for port in range(1, 65536):
        t = threading.Thread(target=scan_port, args=(host, port))
        threads.append(t)
        t.start()
    for t in threads:
        t.join()
    print(f"[+] Scanning completed. Open ports: {open_ports}")

def interact_with_port(host, port):
    try:
        sock = socket.create_connection((host, port), timeout=5)
        print(f"[+] Connected to {host}:{port}. Type commands or 'exit'.\n")
        while True:
            cmd = input(f"{host}:{port}> ")
            if cmd.lower() in ('exit', 'quit'):
                break
            sock.sendall(cmd.encode() + b'\n')
            try:
                response = sock.recv(4096)
                print(response.decode(errors='ignore'))
            except socket.timeout:
                print("[-] No response.")
        sock.close()
    except Exception as e:
        print(f"[-] Error connecting to port {port}: {e}")

def main():
    if len(sys.argv) != 2:
        print(f"Usage: python {sys.argv[0]} <target_host>")
        sys.exit(1)
    target_host = sys.argv[1]
    scan_all_ports(target_host)

    if not open_ports:
        print("[-] No open ports found.")
        return

    while True:
        print("\nSelect a port to interact with (or type 'exit'):")
        for idx, port in enumerate(open_ports):
            print(f"{idx}: Port {port}")
        choice = input("> ")
        if choice.lower() in ('exit', 'quit'):
            break
        try:
            idx = int(choice)
            if 0 <= idx < len(open_ports):
                interact_with_port(target_host, open_ports[idx])
            else:
                print("[-] Invalid index.")
        except ValueError:
            print("[-] Please enter a valid number.")

if __name__ == "__main__":
    main()
